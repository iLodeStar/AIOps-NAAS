# AIOps NAAS v0.3 - Predictive Satellite Link Health + Guarded Auto-Remediation

This document describes the v0.3 implementation of predictive satellite link health monitoring and guarded auto-remediation capabilities.

## New Features in v0.3

### 1. Predictive Link Health Service

**Service**: `link-health` (port 8082)

**Features**:
- Real-time satellite modem KPI monitoring (SNR, BER, Es/No, signal strength)
- Ship telemetry integration (GPS, heading, pitch/roll/yaw)
- Weather data integration for rain fade prediction
- ML-based link quality prediction with 15-minute lead time
- Proactive degradation alerts published to NATS

**Key Metrics Monitored**:
- **SNR (Signal-to-Noise Ratio)**: Primary link quality indicator
- **BER (Bit Error Rate)**: Data transmission quality
- **Signal Strength**: Received power levels
- **Rain Fade Margin**: Available margin for weather impacts
- **Ship Movement**: Pitch, roll, yaw affecting dish pointing
- **Weather**: Precipitation rate, wind speed, atmospheric conditions

**API Endpoints**:
- `GET /health` - Service health check
- `GET /prediction` - Current link quality prediction
- `POST /simulate/modem` - Update simulated modem data for testing

### 2. Guarded Auto-Remediation Service

**Service**: `remediation` (port 8083)

**Features**:
- Approval-gated playbooks for high-risk actions
- Dry-run execution with rollback capabilities
- Policy enforcement via Open Policy Agent (OPA)
- Multiple remediation actions with risk assessment

**Available Remediation Actions**:
1. **Satellite Failover** (HIGH risk, requires approval)
   - Switches to backup satellite link
   - 30-second estimated downtime
   - Automatic rollback available

2. **QoS Traffic Shaping** (MEDIUM risk, auto-approved)
   - Prioritizes critical traffic classes
   - Reduces bandwidth for non-essential services
   - Immediate rollback capability

3. **Bandwidth Reduction** (MEDIUM risk, auto-approved)
   - Reduces overall bandwidth allocation
   - Maintains service availability
   - Configurable reduction percentage

4. **Antenna Realignment** (HIGH risk, requires approval)
   - Adjusts dish elevation and azimuth
   - Improves signal tracking
   - Weather conditions considered

5. **Power Adjustment** (LOW risk, auto-approved)
   - Adjusts transmit power levels
   - Optimizes link budget
   - Quick execution and rollback

6. **Error Correction Enhancement** (LOW risk, auto-approved)
   - Increases forward error correction
   - Improves data reliability
   - Minimal performance impact

**API Endpoints**:
- `GET /health` - Service health check
- `GET /actions` - List available remediation actions
- `POST /execute/{action_id}?dry_run=true` - Execute action with dry-run
- `GET /executions/{execution_id}` - Get execution status
- `POST /rollback/{execution_id}` - Rollback executed action
- `GET /approvals` - List pending approval requests
- `POST /approve/{request_id}` - Approve pending request

### 3. Open Policy Agent (OPA) Integration

**Service**: `opa` (port 8181)

**Features**:
- Policy-driven decision making for remediation actions
- Rate limiting enforcement
- Risk assessment and constraints
- Approval requirement determination

**Policy Rules**:
- **Risk Level Validation**: Ensures actions match allowed risk levels
- **Rate Limiting**: Prevents too many actions per hour by type
- **Approval Requirements**: Determines when human approval is needed
- **Maintenance Windows**: Blocks actions during maintenance (configurable)
- **Preconditions**: Validates system state before execution

## Architecture Integration

### Message Flow

```
1. Link Health Service monitors satellite modem KPIs
2. Predictive model detects degradation risk
3. Alert published to NATS topic: "link.health.alert"
4. Remediation Service receives alert
5. OPA evaluates appropriate remediation action
6. If approved or auto-approved, action is executed
7. Results published to NATS for audit trail
```

### Data Flow

```
Satellite Modem → Link Health Service → Prediction Model
        ↓
    NATS Alert Topic
        ↓
Remediation Service → OPA Policy Check → Action Execution
        ↓
    Audit Trail → NATS → Incident API
```

## Configuration

### Environment Variables

**Link Health Service**:
- `NATS_URL`: NATS message bus URL (default: nats://nats:4222)
- `VICTORIA_METRICS_URL`: Metrics database URL (default: http://victoria-metrics:8428)

**Remediation Service**:
- `NATS_URL`: NATS message bus URL (default: nats://nats:4222)
- `OPA_URL`: Open Policy Agent URL (default: http://opa:8181)

### OPA Policies

Policies are defined in `opa/policies/remediation.rego` and include:

- **Action Limits**: Maximum actions per hour by type
- **Risk Assessment**: Impact evaluation for each action
- **Approval Rules**: Automatic vs. manual approval logic
- **Constraints**: Execution timeouts and rollback requirements

## Testing v0.3 Features

### 1. Start the Stack

```bash
docker compose up -d
```

### 2. Monitor Link Health Predictions

```bash
# Get current prediction
curl http://localhost:8082/prediction

# Check service health
curl http://localhost:8082/health
```

### 3. Simulate Link Degradation

```bash
# Simulate poor SNR to trigger alerts
curl -X POST http://localhost:8082/simulate/modem \
  -H "Content-Type: application/json" \
  -d '{
    "snr_db": 5.0,
    "ber": 0.001,
    "signal_strength_dbm": -85,
    "rain_fade_margin_db": 1.0,
    "elevation_angle_deg": 45,
    "azimuth_angle_deg": 180,
    "frequency_offset_hz": 100,
    "es_no_db": 8.0
  }'
```

### 4. Test Remediation Actions

```bash
# List available actions
curl http://localhost:8083/actions

# Execute dry-run of bandwidth reduction
curl -X POST "http://localhost:8083/execute/bandwidth_reduction?dry_run=true"

# Check execution status
curl http://localhost:8083/executions/{execution_id}

# List pending approvals (for high-risk actions)
curl http://localhost:8083/approvals
```

### 5. Test Policy Enforcement

```bash
# OPA health check
curl http://localhost:8181/health

# Test policy evaluation directly
curl -X POST http://localhost:8181/v1/data/remediation/allow \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "action": {
        "action_type": "qos_traffic_shaping",
        "risk_level": "MEDIUM"
      },
      "context": {
        "recent_actions_count": 2
      }
    }
  }'
```

## Monitoring and Observability

### Service Health Checks

All v0.3 services provide `/health` endpoints for monitoring:

- Link Health Service: http://localhost:8082/health
- Remediation Service: http://localhost:8083/health  
- Open Policy Agent: http://localhost:8181/health

### Grafana Dashboards

The existing Grafana instance (http://localhost:3000) can be extended with:

- Link quality prediction trends
- Remediation action execution metrics
- Policy decision audit logs
- Success/failure rates by action type

### NATS Message Topics

Monitor NATS topics for real-time visibility:

- `link.health.prediction` - Link quality predictions
- `link.health.alert` - Degradation alerts
- `remediation.approval.request` - Approval requests
- `remediation.action.executed` - Action execution results

## Production Deployment

### Kubernetes Deployment

Use the provided Kubernetes manifests in `k8s/base/`:

```bash
kubectl apply -f k8s/base/link-health.yaml
kubectl apply -f k8s/base/remediation.yaml  
kubectl apply -f k8s/base/opa.yaml
```

### Argo CD Integration

Deploy using GitOps with the provided Argo CD application:

```bash
kubectl apply -f argocd/applications/aiops-naas-ship.yaml
```

### Harbor Registry Cache

For low-bandwidth updates, configure Harbor registry cache:

1. Deploy Harbor on the ship
2. Configure Docker to use Harbor as pull-through cache
3. Update image references in deployment manifests

## Security Considerations

### Policy Security

- OPA policies enforce strict limits on remediation actions
- All high-risk actions require human approval
- Rate limiting prevents automated abuse
- Audit trail captures all policy decisions

### Network Security

- Services communicate via internal Docker network
- External access only through defined ports
- NATS authentication can be enabled for production
- mTLS recommended for inter-service communication

### Data Security

- Sensitive configuration via environment variables
- Secrets management via SOPS in production
- Regular security policy updates via GitOps

## Troubleshooting

### Common Issues

1. **Service Not Starting**
   ```bash
   docker compose logs {service-name}
   ```

2. **NATS Connection Issues**
   - Check NATS service health: `docker compose ps nats`
   - Verify NATS_URL environment variable

3. **OPA Policy Errors**
   - Validate policy syntax: `opa fmt opa/policies/remediation.rego`
   - Check OPA logs: `docker compose logs opa`

4. **Prediction Model Issues**
   - Ensure VictoriaMetrics is accessible
   - Check for sufficient historical data
   - Verify modem KPI data availability

### Debug Commands

```bash
# Check all service health
curl http://localhost:8082/health  # Link Health
curl http://localhost:8083/health  # Remediation  
curl http://localhost:8181/health  # OPA

# View NATS topics
docker compose exec nats nats sub ">" --count=10

# Check recent executions
curl http://localhost:8083/executions/
```

## Next Steps - v0.4 Features

The v0.3 implementation provides the foundation for v0.4 fleet management:

- Central fleet control plane
- Cross-ship correlation and benchmarking
- Capacity forecasting for seasonal routes
- Multi-ship GitOps deployment waves

See `docs/roadmap.md` for complete v0.4 requirements.